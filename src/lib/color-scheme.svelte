<script lang="ts" module>
  import { colors as enderColorScheme } from "./color-scheme/green.js";
  import { colors as enderDarkColorScheme } from "./color-scheme/green-dark.js";

  import { derived as d, derived, get } from "svelte/store";
  import { persisted } from "svelte-persisted-store";
	import type { ColorKey, ColorSchemeName, ColorValues } from "./types.js";

  export const intColorToHex = (color: number): string =>
    `#${color.toString(16)}`;

  export const registeredColors: Record<ColorSchemeName, ColorValues> = {
    ["Green"]: enderColorScheme(),
    ["Green Dark"]: enderDarkColorScheme(),
  };

  export function registerColorScheme(theme: string, colorScheme: ColorValues) {
    if (theme in registeredColors) {
      console.warn(`Color scheme ${theme} already exists. Overriding...`);
    }

    registeredColors[theme] = colorScheme;
  }
  export function getColorInt(
    key: ColorKey,
    theme: ColorSchemeName = get(currentColorScheme)
  ): number | null {
    return registeredColors?.[theme]?.[key] ?? 0;
  }

  export function getColorHex(key: ColorKey, theme?: ColorSchemeName) {
    return `#${getColorInt(key, theme)?.toString(16).padStart(8, "0")}`;
  }

  export function getColorRgba(key: ColorKey, theme?: ColorSchemeName) {
    const hex = getColorHex(key, theme);

    const red = Number.parseInt(hex.slice(0, 2), 16);
    const green = Number.parseInt(hex.slice(2, 4), 16);
    const blue = Number.parseInt(hex.slice(4, 6), 16);
    const alpha = Number.parseInt(hex.slice(6, 8), 16);

    return `rgba(${red}, ${green}, ${blue}, ${alpha / 255})`;
  }

  function generateCssPropertyDeclarations(theme: ColorSchemeName) {
    const color = registeredColors[theme];

    let style = "";

    for (const key in color) {
      if (style.length !== 0) {
        style += "; ";
      }

      const value = color[key as ColorKey].toString(16).padStart(8, "0")

      style += `--${key}: #${value}`;
    }

    return style;
  }

  const currentColorScheme = persisted("color-scheme", "Green", {
    serializer: {
      parse: (value) => (value in registeredColors ? value : "Green"),
      stringify: (value) => value,
    },
  });

  export function setColorScheme(theme: ColorSchemeName) {
    if (!(theme in registeredColors)) {
      throw new Error(`Color scheme ${theme} does not exist.`);
    }

    currentColorScheme.set(theme);
  }

  const readonlyCurrentColorScheme = d(currentColorScheme, (value) => value);
  export { readonlyCurrentColorScheme as currentColorScheme };
</script>

<script lang="ts">
  const { colorScheme = undefined }: { colorScheme?: ColorSchemeName } = $props();

  const useColorScheme = derived(currentColorScheme, (theme) => colorScheme ?? theme);
  const style = derived(useColorScheme, (theme) => `<style>body { ${generateCssPropertyDeclarations(theme)} }</style>`);
</script>

<svelte:head>
  {#key $useColorScheme}
    {@html $style}
  {/key}
</svelte:head>
